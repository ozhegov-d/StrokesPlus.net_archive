sp.StoreBool('capsActive', false);
sp.StoreString('capsNumbers', '');
sp.StoreString('capsLastKeys', '');
sp.StoreBool('capsWasToggled', false);

sp.CreateTimer('capsDigitTimer', 30, 1, String.raw`
    var capsDown = sp.IsKeyDown(vk.CAPITAL);
    var wasActive = sp.GetStoredBool('capsActive');
    
    if (capsDown && !wasActive) {
        var capsToggledNow = sp.IsKeyToggled(vk.CAPITAL);
        sp.StoreBool('capsWasToggled', !capsToggledNow);
        sp.StoreBool('capsActive', true);
        sp.StoreString('capsNumbers', '');
        sp.StoreString('capsLastKeys', '');
    } else if (capsDown && wasActive) {
        var currentKeys = '';
        var keys = [vk.VK_0, vk.VK_1, vk.VK_2, vk.VK_3, vk.VK_4, 
                    vk.VK_5, vk.VK_6, vk.VK_7, vk.VK_8, vk.VK_9];
        
        for (var i = 0; i < 10; i++) {
            if (sp.IsKeyDown(keys[i])) currentKeys += i;
        }
        
        var lastKeys = sp.GetStoredString('capsLastKeys');
        
        if (currentKeys !== lastKeys) {
            if (currentKeys) {
                sp.StoreString('capsNumbers', 
                    (sp.GetStoredString('capsNumbers') || '') + currentKeys);
            }
            sp.StoreString('capsLastKeys', currentKeys);
        }
    } else if (!capsDown && wasActive) {
        sp.StoreBool('capsActive', false);
        var numbers = sp.GetStoredString('capsNumbers');
        var capsWasToggled = sp.GetStoredBool('capsWasToggled');
        
        if (numbers) {
            sp.StoreString('capsNumbers', '');
            sp.StoreString('capsLastKeys', '');
            
            sp.Sleep(30);
            sp.SendModifiedVKeys([vk.LCONTROL], [vk.VK_G]);
            sp.Sleep(100);
            sp.SendString(numbers);
            sp.Sleep(40);
            sp.SendVKey(vk.RETURN);
            
            // Restoring Caps Lock
            sp.Sleep(50);
            if (sp.IsKeyToggled(vk.CAPITAL) !== capsWasToggled) {
                sp.SendVKey(vk.CAPITAL);
            }
        }
    }
`);

